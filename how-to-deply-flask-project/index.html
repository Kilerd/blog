<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/statics/style.css">
    <link rel="alternate" type="application/rss+xml" title="你好，耳先生" href="/rss.xml" />
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <title>如何正确的部署 Flask 项目</title>
</head>

<body>


    <section class="full-page">
        <section class="container">

            <section class="single article">
                <p class="mate">November 25, 2016</p>
                <h2>如何正确的部署 Flask 项目</h2>
                <section class="content yue line-numbers">
                    <h1>系统 Python 设置</h1>
<p>由于每个 Linux 发行版的内置 Python 都不太一样，而且为了避免你的项目在不同的 Python 版本下出现各种奇怪问题。</p>
<p>比如，<code>requests</code> 库在 python 2.7.5 的环境下访问 HTTPS 网站会出现 SNI 的问题，导致访问失败。</p>
<p>所以我们需要使用 <code>pyenv</code> 和 <code>virtualenv</code> 。</p>
<p><strong>注：强烈不建议直接更新系统里面的 Python ，否则你会出现各种各样的奇怪问题</strong></p>
<!--more-->
<h2>pyenv</h2>
<p>pyenv 允许你在一台机器上配置多个版本的 python 环境</p>
<h3>安装</h3>
<pre><code class="language-bash">sudo apt-get install curl git-core // 依赖库
curl -L https://raw.github.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash
</code></pre>
<p>如果执行成功，那么 <code>pyenv</code> 就会安装到 <code>~/.pyenv</code> 目录里面。</p>
<p>为了方便我们用 <code>pyenv subcommand</code> 的方法来调用 <code>pyenv</code> ，我们要在 <code>~/.bashrc</code> 文件中添加以下内容</p>
<pre><code class="language-bash">export PYENV_ROOT=&quot;${HOME}/.pyenv&quot;

if [ -d &quot;${PYENV_ROOT}&quot; ]; then
  export PATH=&quot;${PYENV_ROOT}/bin:${PATH}&quot;
  eval &quot;$(pyenv init -)&quot;
fi
</code></pre>
<p><code>~/.bashrc</code> 的作用大概就是用户配置文件</p>
<p>执行 <code>source ~/.bashrc</code>  以重新加载用户配置文件。</p>
<p>至此，<code>pyenv</code> 就安装好了。</p>
<h3>使用</h3>
<ul>
<li>
<p><code>pyenv install --list</code></p>
<p>列出目前 <code>pyenv</code> 安装过的所有 Python 版本</p>
</li>
<li>
<p><code>pyenv install $version</code></p>
<p><code>$version</code> 就是你想要安装的 Python 版本</p>
</li>
<li>
<p><code>pyenv versions</code> </p>
<p>显示当前系统用的是哪个 Python 版本</p>
</li>
<li>
<p><code>pyenv global $version</code></p>
<p>把当前系统的 Python 版本切换到 <code>$version</code> 这个版本。该命令在本教材中并不用到，故不多介绍，如果你想了解更多，可以查看<code>pyenv</code> 的 API 文档</p>
</li>
</ul>
<h2>virtualenv</h2>
<p>用于分离 Python 库</p>
<h3>安装</h3>
<p>如果你是使用以上的方法安装<code>pyenv</code>的话，那么 <code>virtualenv</code> 就已经安装完了。
<strong>强烈不建议用其他方法安装 virtualenv， 那将会是一种很麻烦很折腾的方法</strong></p>
<h3>使用</h3>
<ul>
<li>
<p><code>pyenv virtualenv $version $name</code></p>
<p>用于创建一个指定 Python 版本的虚拟环境</p>
<ul>
<li><code>$version</code> 你需要的 Python 版本</li>
<li><code>$name</code> 该虚拟环境的名称</li>
</ul>
</li>
<li>
<p><code>rm -rf ~/.pyenv/versions/$name/</code></p>
<p>删除名称为<code>$name</code>的虚拟环境。 </p>
</li>
</ul>
<p><strong>注意： 这里用到了<code>rm -rf</code> 谨慎使用，使用前先检查代码</strong></p>
<h1>基本需求</h1>
<p>首先我们需要一下这几个库来来帮助我们部署，建议在 virtualenv 中安装，以免感染系统</p>
<ul>
<li>
<p><code>gunicorn</code></p>
<p>用 WSGI 的方式来启动 flask 项目</p>
</li>
<li>
<p><code>gevent</code></p>
<p>python 中比较好的网络库，提供更加高效的 I/O 读写</p>
</li>
<li>
<p><code>supervisor</code></p>
<p>守护进程，避免进程意外退出</p>
</li>
</ul>
<p>安装方法：</p>
<pre><code class="language-shell">pip install gunicorn gevent supervisor
</code></pre>
<h1>部署你的 Flask 项目</h1>
<h2>Flask 项目结构</h2>
<p>为了做演示，我们暂定需要部署的 Flask 项目结构是这个样子的</p>
<pre><code>flaskproject
|----app
|----|----templates
|----|----static
|----|----models.py
|----|----views
|----|----|----__init__.py
|----|----|----user.py
|----|----functions.py
|----config.py
|----run.py
</code></pre>
<p><strong>项目结构并不是固定的，可以自己根据自己项目的情况自行分配</strong></p>
<p><code>run.py</code> 中就是 Flask 项目的入口，内容大致如下</p>
<pre><code class="language-python">from flask import Flask

app = Flask()

# ... some configs
</code></pre>
<p>或者使用<code>create_app()</code> 模式</p>
<pre><code class="language-python">from flask import Flask

def create_app():
    app = Flask()
    
    # ... some configs
    
    return app
</code></pre>
<h2>Supervisor + Gunicorn + Gevent</h2>
<h3>前提设置</h3>
<p>首先启动之前已经创建好的 virtualenv 虚拟环境</p>
<pre><code class="language-shell">pyenv activate $name
</code></pre>
<p>如果正常启动的话，在 bash 命令行上面应该会出现环境的名字</p>
<pre><code class="language-shell">($name) # 
</code></pre>
<p>没正常启动的样子是这样的</p>
<pre><code class="language-shell"># 
</code></pre>
<p>进去之后呢，用<code>pip</code> 安装你的项目依赖</p>
<pre><code class="language-shell">pip install -r requirements.txt
</code></pre>
<h3>配置 Supervisor</h3>
<p>进入项目文件夹</p>
<p>然后输出 supervisor 默认配置文件 <code>supervisor.conf</code> : (<code>$name</code> 是 virtualenv 环境的名称)</p>
<pre><code class="language-shell">~/.pyenv/versions/$name/bin/echo_supervisord_conf &gt; supervisor.conf
</code></pre>
<p>然后打开 <code>supervisor.conf</code> ，然后在文件的最后添加一下内容</p>
<pre><code>[program:myapp]
command=~/.pyenv/versions/$name/bin/gunicorn -k gevent -w2 -b0.0.0.0:9000 run:app   ; supervisor启动命令
directory=/home/myproject                                                 ; 项目的文件夹路径
startsecs=0                                                               ; 启动时间
stopwaitsecs=0                                                            ; 终止等待时间
autostart=true                                                            ; 是否自动启动
autorestart=true                                                          ; 是否自动重启
stdout_logfile=/home/myproject/log/gunicorn.log                           ; log 日志
stderr_logfile=/home/myproject/log/gunicorn.err                           ; 错误日志
</code></pre>
<ul>
<li><code>command</code>  中的是用 <code>gunicorn</code> 和 <code>gevent</code> 启用 Flask 项目的命令
<ul>
<li><code>-w2</code> 指的是 <code>2 worker</code> 一般设置成 <code>2 * cpu_nums</code> </li>
<li><code>-b0.0.0.0:9000</code> 指的是启动在 9000 端口</li>
<li><code>run:app</code> 是 Flask 项目入口，如果你用的是<code>create_app()</code> 方法的话， 就改成<code>run:create_app()</code></li>
</ul>
</li>
<li><strong>所有目录都需要使用绝对路径</strong></li>
</ul>
<h3>操作 Supervisor</h3>
<ul>
<li>
<p>启动 Supervisor</p>
<p><code>~/.pyenv/versions/$name/bin/supervisord -c supervisor.conf</code></p>
</li>
<li>
<p>查看 Supervisor 情况</p>
<p><code>~/.pyenv/versions/$name/bin/supervisorctl -c supervisor.conf status</code></p>
</li>
<li>
<p>重启 Supervisor</p>
<p><code>~/.pyenv/versions/$name/bin/supervisorctl -c supervisor.conf reload</code></p>
</li>
<li>
<p>启动 Supervisor 中某个 / 全部程序</p>
<p><code>~/.pyenv/versions/$name/bin/supervisorctl -c supervisor.conf start [all][appname]</code></p>
</li>
<li>
<p>关闭 Supervisor 中某个 / 全部程序</p>
<p><code>~/.pyenv/versions/$name/bin/supervisorctl -c supervisor.conf stop [all][appname]</code></p>
</li>
</ul>
<p>配置好你的 <code>supervisor.conf</code> 文件后，执行启动命令，如果没打错命令基本就已经启动好了，这个时候你应该就可以访问 <code>http://ip:9000</code> 来访问到你的 Flask 项目</p>
<h1>Nginx 设置</h1>
<p>这里只讨论如何使用 Nginx ，Apache 党请自行转换</p>
<h2>Nginx 安装</h2>
<p>详情查看 <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/install/">Install | Nginx</a></p>
<h2>Nginx 配置</h2>
<p>进入 Nginx配置文件，或者<code>/etc/nginx/conf.d/default.conf</code> ，或者新建 <code>/etc/nginx/conf.d/myproject.conf</code>，修改配置文件，以下这是几个建议的配置</p>
<ul>
<li>
<p>禁止 IP 访问</p>
<pre><code>server {
    listen       80 default_server;
    listen       [::]:80 default_server;
    server_name  _;

    location / {
        return 404;
    }
}
</code></pre>
</li>
<li>
<p>禁止 HTTP 访问</p>
<pre><code>server {
    listen               80;
    server_name          www.myproject.com myproject.com;
    server_tokens        off;
    
    # 跳转至 HTTPS
    location / {
        rewrite ^/(.*)$ https://myproject.com/$1 permanent;
    }
}
</code></pre>
</li>
<li>
<p>HTTPS设置 / 443端口设置</p>
<pre><code>server {
    listen               443 ssl http2 fastopen=3 reuseport;

    server_name          www.myproject.com myproject.com;
    server_tokens        off;

	# SSL 设置
    ssl_certificate      /root/.acme.sh/myproject.com_ecc/fullchain.cer;
    ssl_certificate_key  /root/.acme.sh/myproject.com_ecc/myproject.com.key;
    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ssl_prefer_server_ciphers  on;
    ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache          shared:SSL:50m;
    ssl_session_timeout        1d;
    ssl_session_tickets        on;
    ssl_stapling               on;
    ssl_stapling_verify        on;
    resolver                   114.114.114.114 valid=300s;
    resolver_timeout           10s;

	
	# NGINX 日志
    access_log                 /home/myproject/log/nginx.log;

	# 禁止非 GET HEAD POST OPTIONS 的访问
    if ($request_method !~ ^(GET|HEAD|POST|OPTIONS)$ ) {
        return           444;
    }
	
	# www.myproject.com 跳转至 myproject.com
	# 可有可无，看个人情况
    if ($host != 'myproject.com' ) {
        rewrite          ^/(.*)$  https://myproject.com/$1 permanent;
    }
	
	# 代理 Flask 端口
    location / {
        proxy_http_version       1.1;
		
		# HSTS 头设置
        add_header               Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;;
        add_header               X-Frame-Options deny;
        
        # 添加两个 Request Header
        proxy_set_header         X-Real_IP        $remote_addr;
        proxy_set_header         X-Forwarded-For  $proxy_add_x_forwarded_for;
		
		# 代理 9000 端口
        proxy_pass               http://127.0.0.1:9000;
    }
}
</code></pre>
</li>
</ul>
<p><strong>这里的SSL申请是用 <a href="https://github.com/Neilpang/acme.sh">acme.sh</a> 申请的 Let‘s Encrypt ECC证书</strong></p>
<p>然后重启 Nginx ，项目就配置完成了。就可以使用域名正常访问了（DNS解析正常的情况下）</p>
<h1>快捷使用方式</h1>
<p>因为 Python 的执行方式不像 PHP 那样的脚本式执行，所以当项目代码更新后，需要重启才能使代码生效。</p>
<p>为了方便重启，我们在项目的根目录下创建<code>reload.sh</code></p>
<pre><code class="language-shell">git pull  // 我是使用 git 拉去项目代码的，这里的作用是更新项目代码
~/.pyenv/versions/$name/bin/supervisorctl -c supervisor.conf reload  // 重启 Supervisor
echo 'Reload Done'
</code></pre>
<p>下次我们就可以直接用 <code>sh reload.sh</code> 来直接更新项目状态了</p>
<h1>注意事项</h1>
<ul>
<li>服务器的配置不止如此，<code>iptables</code> 等等相关软件限制端口访问</li>
<li>建议只允许 HTTPS 访问</li>
<li>如果不限制端口访问，不建议把 <code>supervisor</code> 配置中的监听端口暴露（即使用9000端口）</li>
</ul>
<p>待完善的内容</p>
<ul>
<li>建议使用 <code>fabric </code>来代替<code>sh reload.sh</code> 的执行方式</li>
<li>log 文件如何更高效地分析</li>
<li>期待下一篇文章把，下一次将完善这些内容</li>
</ul>

                </section>
            </section>
            <div id="gitalk-container"></div>
        </section>
    </section>


    <footer>
        <section class="container">
            <p> 自豪地使用 <a href="https://github.com/Kilerd/staple">Project Staple</a> 运行。 </p>
            <div style="display:none"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-68997851-1"></script> <script>   window.dataLayer = window.dataLayer || [];   function gtag(){dataLayer.push(arguments);}   gtag('js', new Date());    gtag('config', 'UA-68997851-1'); </script>
</div>
        </section>
    </footer>
    <script src="/statics/prism.js" type="text/javascript"></script>
    <script>
        const gitalk = new Gitalk({
            clientID: 'ea9ccdac4ebba34d5a92',
            clientSecret: 'b667966304d59b4059d72148ee81c1af288bf466',
            repo: 'blog',      // The repository of store comments,
            owner: 'Kilerd',
            admin: ['Kilerd'],
            id: location.pathname,      // Ensure uniqueness and length less than 50
            distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</body>

</html>